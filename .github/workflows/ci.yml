name: Comprehensive CI Pipeline

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Job 1: Build and test Rust/WASM components
  build-rust-wasm:
    name: Build Rust & WASM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          override: true
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache target directory
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Run Rust unit tests
        run: cargo test --workspace --lib --bins
        env:
          RUST_BACKTRACE: 1

      - name: Build WASM
        run: ./build-wasm.sh

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wasm-build
          path: |
            frontend/public/pkg/
          retention-days: 7

  # Job 2: Build frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: build-rust-wasm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Download WASM artifacts
        uses: actions/download-artifact@v3
        with:
          name: wasm-build
          path: frontend/public/pkg/

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend with webpack
        working-directory: ./frontend
        run: npm run build:frontend-webpack
        env:
          NODE_ENV: 'production'
          VITE_USE_WASM: 'true'

      - name: Upload frontend build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

  # Job 3: UI Tests with Playwright
  ui-tests:
    name: Playwright UI Tests
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Download frontend build
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: frontend/dist/

      - name: Install Playwright
        run: |
          npm install -D playwright@latest serve
          npx playwright install chromium

      - name: Create bot-settings.json with RPC URLs from secrets
        working-directory: ./frontend/dist
        run: |
          cat > bot-settings.json << EOF
          {
            "_comment": "CI test deployment with RPC URLs from repository secrets",
            "solana_ws_urls": ["${{ secrets.SOLANA_WS_URL || 'wss://api.mainnet-beta.solana.com' }}"],
            "solana_rpc_urls": ["${{ secrets.SOLANA_RPC_URL || 'https://api.mainnet-beta.solana.com' }}"],
            "pump_fun_program": "6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P",
            "metadata_program": "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s",
            "tp_percent": 100.0,
            "sl_percent": -50.0,
            "timeout_secs": 50,
            "buy_amount": 0.001,
            "max_holded_coins": 4,
            "slippage_bps": 500,
            "min_tokens_threshold": 30000,
            "max_sol_per_token": 0.002,
            "min_liquidity_sol": 0.0,
            "max_liquidity_sol": 15.0,
            "dev_tip_percent": 2.0,
            "dev_tip_fixed_sol": 0.0,
            "shyft_api_key": "${{ secrets.SHYFT_API_KEY || '' }}",
            "shyft_graphql_url": "https://programs.shyft.to/v0/graphql"
          }
          EOF
          echo "bot-settings.json created with secrets"

      - name: Start HTTP server and run Playwright tests
        run: |
          # Start server in background
          npx serve frontend/dist -l 8080 &
          SERVER_PID=$!
          echo "Server started with PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 5
          
          # Run Playwright tests
          node test-with-playwright.mjs http://localhost:8080/sol_beast/
          TEST_EXIT_CODE=$?
          
          # Kill server
          kill $SERVER_PID || true
          
          exit $TEST_EXIT_CODE

      - name: Upload Playwright screenshots
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-ui-screenshots
          path: |
            *.png
            playwright-report/
          retention-days: 14

  # Job 4: WASM Bot Functionality Tests
  bot-functionality-tests:
    name: WASM Bot Functionality Tests
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Download frontend build
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: frontend/dist/

      - name: Install Playwright
        run: |
          npm install -D playwright@latest serve
          npx playwright install chromium

      - name: Create bot-settings.json with all secrets
        working-directory: ./frontend/dist
        run: |
          cat > bot-settings.json << EOF
          {
            "_comment": "Bot functionality test with working RPC and Shyft credentials",
            "solana_ws_urls": ["${{ secrets.SOLANA_WS_URL || 'wss://api.mainnet-beta.solana.com' }}"],
            "solana_rpc_urls": ["${{ secrets.SOLANA_RPC_URL || 'https://api.mainnet-beta.solana.com' }}"],
            "pump_fun_program": "6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P",
            "metadata_program": "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s",
            "tp_percent": 100.0,
            "sl_percent": -50.0,
            "timeout_secs": 50,
            "buy_amount": 0.001,
            "max_holded_coins": 4,
            "slippage_bps": 500,
            "min_tokens_threshold": 30000,
            "max_sol_per_token": 0.002,
            "min_liquidity_sol": 0.0,
            "max_liquidity_sol": 15.0,
            "dev_tip_percent": 2.0,
            "dev_tip_fixed_sol": 0.0,
            "shyft_api_key": "${{ secrets.SHYFT_API_KEY || '' }}",
            "shyft_graphql_url": "https://programs.shyft.to/v0/graphql"
          }
          EOF
          echo "bot-settings.json created with all secrets for bot testing"

      - name: Start HTTP server and run bot tests
        run: |
          # Start server in background
          npx serve frontend/dist -l 8080 &
          SERVER_PID=$!
          echo "Server started with PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 5
          
          # Run bot functionality tests (3 minute monitoring window)
          SOLANA_RPC_URL="${{ secrets.SOLANA_RPC_URL || 'https://api.mainnet-beta.solana.com' }}" \
          SOLANA_WS_URL="${{ secrets.SOLANA_WS_URL || 'wss://api.mainnet-beta.solana.com' }}" \
          node test-bot-functionality.mjs http://localhost:8080/sol_beast/ 180
          TEST_EXIT_CODE=$?
          
          # Kill server
          kill $SERVER_PID || true
          
          exit $TEST_EXIT_CODE

      - name: Upload bot test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bot-test-results
          path: |
            *.png
            bot-test-*.json
            bot-console-log.txt
          retention-days: 14

  # Job 5: Generate test summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-rust-wasm, build-frontend, ui-tests, bot-functionality-tests]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate summary
        run: |
          echo "# CI Test Summary" > summary.md
          echo "" >> summary.md
          echo "## Build Status" >> summary.md
          echo "- Rust/WASM Build: ${{ needs.build-rust-wasm.result }}" >> summary.md
          echo "- Frontend Build: ${{ needs.build-frontend.result }}" >> summary.md
          echo "" >> summary.md
          echo "## Test Results" >> summary.md
          echo "- UI Tests: ${{ needs.ui-tests.result }}" >> summary.md
          echo "- Bot Functionality Tests: ${{ needs.bot-functionality-tests.result }}" >> summary.md
          echo "" >> summary.md
          echo "## Artifacts" >> summary.md
          echo "All test artifacts (screenshots, logs, reports) are available in the workflow run artifacts." >> summary.md
          echo "" >> summary.md
          echo "ðŸ“± **Mobile-Friendly**: All artifacts can be downloaded and viewed from your phone via the GitHub Actions interface." >> summary.md
          cat summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: summary.md
          retention-days: 30
