name: Validate CI Setup

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-secrets:
    name: Check Required Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check SOLANA_RPC_URL
        run: |
          if [ -z "${{ secrets.SOLANA_RPC_URL }}" ]; then
            echo "‚ùå SOLANA_RPC_URL is not set"
            echo "Please add this secret in Settings > Secrets and variables > Actions"
            exit 1
          else
            echo "‚úÖ SOLANA_RPC_URL is configured"
            # Verify it's a valid URL format
            if [[ "${{ secrets.SOLANA_RPC_URL }}" == http* ]]; then
              echo "‚úÖ URL format looks valid"
            else
              echo "‚ö†Ô∏è Warning: URL should start with http:// or https://"
            fi
          fi

      - name: Check SOLANA_WS_URL
        run: |
          if [ -z "${{ secrets.SOLANA_WS_URL }}" ]; then
            echo "‚ùå SOLANA_WS_URL is not set"
            echo "Please add this secret in Settings > Secrets and variables > Actions"
            exit 1
          else
            echo "‚úÖ SOLANA_WS_URL is configured"
            # Verify it's a valid WebSocket URL format
            if [[ "${{ secrets.SOLANA_WS_URL }}" == ws* ]]; then
              echo "‚úÖ WebSocket URL format looks valid"
            else
              echo "‚ö†Ô∏è Warning: WebSocket URL should start with ws:// or wss://"
            fi
          fi

      - name: Check SHYFT_API_KEY (optional)
        run: |
          if [ -z "${{ secrets.SHYFT_API_KEY }}" ]; then
            echo "‚ö†Ô∏è SHYFT_API_KEY is not set (optional but recommended)"
            echo "Get a free API key at https://shyft.to"
          else
            echo "‚úÖ SHYFT_API_KEY is configured"
          fi

      - name: Test RPC connectivity
        run: |
          echo "Testing RPC endpoint connectivity..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.SOLANA_RPC_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","id":1,"method":"getHealth"}' \
            --max-time 10)
          
          if [ "$RESPONSE" -eq 200 ]; then
            echo "‚úÖ RPC endpoint is accessible and responding"
          else
            echo "‚ö†Ô∏è RPC endpoint returned HTTP $RESPONSE"
            echo "This might still work, but verify your URL is correct"
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=== Setup Validation Summary ==="
          echo ""
          echo "Required secrets:"
          echo "  - SOLANA_RPC_URL: ${{ secrets.SOLANA_RPC_URL != '' && '‚úÖ Configured' || '‚ùå Missing' }}"
          echo "  - SOLANA_WS_URL: ${{ secrets.SOLANA_WS_URL != '' && '‚úÖ Configured' || '‚ùå Missing' }}"
          echo ""
          echo "Optional secrets:"
          echo "  - SHYFT_API_KEY: ${{ secrets.SHYFT_API_KEY != '' && '‚úÖ Configured' || '‚ö†Ô∏è Not set' }}"
          echo ""
          echo "Next steps:"
          echo "  1. If any required secrets are missing, add them in repository Settings"
          echo "  2. Run the 'Comprehensive CI Pipeline' workflow to test everything"
          echo "  3. Check the artifacts for screenshots and test results"
          echo ""
          echo "üìñ Documentation: See QUICK_START_CI.md for detailed instructions"
