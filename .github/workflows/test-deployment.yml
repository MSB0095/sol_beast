name: Test GitHub Pages Deployment

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          override: true

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Install mdbook
        run: |
          mkdir -p ~/.cargo/bin
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar -xz -C ~/.cargo/bin
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Build WASM
        run: ./build-wasm.sh

      - name: Build Documentation
        run: ./build-docs.sh

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Create bot-settings.json with RPC URLs from secrets
        working-directory: ./frontend/public
        run: |
          cat > bot-settings.json << EOF
          {
            "_comment": "Test deployment with working RPC URLs from repository secrets",
            "solana_ws_urls": ["${{ secrets.SOLANA_WS_URL || 'wss://api.mainnet-beta.solana.com' }}"],
            "solana_rpc_urls": ["${{ secrets.SOLANA_RPC_URL || 'https://api.mainnet-beta.solana.com' }}"],
            "pump_fun_program": "6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P",
            "metadata_program": "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s",
            "tp_percent": 100.0,
            "sl_percent": -50.0,
            "timeout_secs": 50,
            "buy_amount": 0.001,
            "max_holded_coins": 4,
            "slippage_bps": 500,
            "min_tokens_threshold": 30000,
            "max_sol_per_token": 0.002,
            "min_liquidity_sol": 0.0,
            "max_liquidity_sol": 15.0,
            "dev_tip_percent": 2.0,
            "dev_tip_fixed_sol": 0.0,
            "shyft_api_key": "${{ secrets.SHYFT_API_KEY || '' }}",
            "shyft_graphql_url": "https://programs.shyft.to/v0/graphql"
          }
          EOF
          cat bot-settings.json

      - name: Build frontend with webpack
        working-directory: ./frontend
        run: npm run build:frontend-webpack
        env:
          NODE_ENV: 'production'
          VITE_USE_WASM: 'true'

      - name: Copy documentation to dist
        run: |
          mkdir -p ./frontend/dist/sol_beast_docs
          cp -r ./sol_beast_docs/book/* ./frontend/dist/sol_beast_docs/

      - name: Install Playwright
        working-directory: ./frontend
        run: |
          npm install -D playwright@latest
          npx playwright install chromium

      - name: Start HTTP server and test with Playwright
        working-directory: ./frontend
        run: |
          # Start a simple HTTP server in the background
          npx serve dist -l 8080 &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Create a simple Playwright test script
          cat > test-deployment.mjs << 'EOF'
          import { chromium } from 'playwright';

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            
            // Capture console messages
            const consoleMessages = [];
            page.on('console', msg => {
              consoleMessages.push({
                type: msg.type(),
                text: msg.text(),
                location: msg.location()
              });
            });
            
            // Capture page errors
            const pageErrors = [];
            page.on('pageerror', error => {
              pageErrors.push({
                message: error.message,
                stack: error.stack
              });
            });
            
            // Navigate to the app
            console.log('Navigating to http://localhost:8080/sol_beast/');
            await page.goto('http://localhost:8080/sol_beast/', { waitUntil: 'networkidle', timeout: 30000 });
            
            // Wait a bit for the app to initialize
            await page.waitForTimeout(5000);
            
            // Take a screenshot
            await page.screenshot({ path: 'screenshot.png', fullPage: true });
            console.log('Screenshot saved as screenshot.png');
            
            // Print console messages
            console.log('\n=== CONSOLE MESSAGES ===');
            consoleMessages.forEach((msg, idx) => {
              console.log(`[${idx + 1}] [${msg.type.toUpperCase()}] ${msg.text}`);
              if (msg.location) {
                console.log(`    at ${msg.location.url}:${msg.location.lineNumber}:${msg.location.columnNumber}`);
              }
            });
            
            // Print page errors
            if (pageErrors.length > 0) {
              console.log('\n=== PAGE ERRORS ===');
              pageErrors.forEach((error, idx) => {
                console.log(`[${idx + 1}] ${error.message}`);
                if (error.stack) {
                  console.log(error.stack);
                }
              });
            } else {
              console.log('\n=== NO PAGE ERRORS ===');
            }
            
            // Check for specific error patterns
            const errorMessages = consoleMessages.filter(msg => msg.type === 'error');
            const warningMessages = consoleMessages.filter(msg => msg.type === 'warning');
            
            // Filter out expected/non-critical errors
            const criticalErrors = errorMessages.filter(msg => {
              const text = msg.text.toLowerCase();
              // Ignore external CDN failures (expected in CI)
              if (text.includes('iconify.design') || text.includes('googleapis.com')) return false;
              // Ignore expected backend API 404s
              if (text.includes('/health') || text.includes('/settings')) return false;
              // Ignore development resource references
              if (text.includes('/src/main.tsx') || text.includes('vite.svg')) return false;
              return true;
            });
            
            console.log(`\n=== SUMMARY ===`);
            console.log(`Total console messages: ${consoleMessages.length}`);
            console.log(`Errors: ${errorMessages.length}`);
            console.log(`Warnings: ${warningMessages.length}`);
            console.log(`Critical errors: ${criticalErrors.length}`);
            console.log(`Page errors: ${pageErrors.length}`);
            
            await browser.close();
            
            // Only fail on critical errors or page exceptions
            if (criticalErrors.length > 0 || pageErrors.length > 0) {
              console.log('\n❌ TEST FAILED: Critical errors or exceptions detected');
              process.exit(1);
            } else {
              console.log('\n✅ TEST PASSED: No critical errors detected');
            }
          })();
          EOF
          
          # Run the test
          node test-deployment.mjs
          
          # Kill the server
          kill $SERVER_PID || true

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-screenshot
          path: frontend/screenshot.png
