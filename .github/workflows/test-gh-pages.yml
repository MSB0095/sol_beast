name: Test GitHub Pages Deployment

on:
  push:
    branches:
      - copilot/test-gh-page-deployment
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "test-pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Install mdbook
        run: |
          mkdir -p ~/.cargo/bin
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar -xz -C ~/.cargo/bin
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Build WASM
        run: ./build-wasm.sh

      - name: Build Documentation
        run: ./build-docs.sh

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Configure bot-settings.json with secrets
        working-directory: ./frontend/public
        env:
          HELIUS_WSS: ${{ secrets.HELIUS_WSS }}
          HELIUS_HTTPS: ${{ secrets.HELIUS_HTTPS }}
        run: |
          # Create bot-settings.json with secret RPC URLs using jq for safe JSON construction
          jq -n \
            --arg wss "$HELIUS_WSS" \
            --arg https "$HELIUS_HTTPS" \
            '{
              "_comment": "Test configuration using Helius RPC endpoints from GitHub secrets",
              "solana_ws_urls": [$wss],
              "solana_rpc_urls": [$https],
              "pump_fun_program": "6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P",
              "metadata_program": "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s",
              "tp_percent": 100.0,
              "sl_percent": -50.0,
              "timeout_secs": 50,
              "buy_amount": 0.001,
              "max_holded_coins": 4,
              "slippage_bps": 500,
              "min_tokens_threshold": 30000,
              "max_sol_per_token": 0.002,
              "min_liquidity_sol": 0.0,
              "max_liquidity_sol": 15.0,
              "dev_tip_percent": 2.0,
              "dev_tip_fixed_sol": 0.0
            }' > bot-settings.json
          echo "‚úì bot-settings.json configured with secret RPC URLs (not logged for security)"

      - name: Build frontend with webpack
        working-directory: ./frontend
        run: npm run build:frontend-webpack
        env:
          NODE_ENV: 'production'
          VITE_USE_WASM: 'true'

      - name: Copy documentation to dist
        run: |
          mkdir -p ./frontend/dist/sol_beast_docs
          cp -r ./sol_beast_docs/book/* ./frontend/dist/sol_beast_docs/

      - name: Create test instructions file
        run: |
          cat > ./frontend/dist/TEST_INSTRUCTIONS.md << 'EOF'
          # Test Instructions for GitHub Pages Deployment

          ## What This Test Does

          This workflow tests the GitHub Pages deployment of Sol Beast in WASM-only mode with the following configuration:

          1. **RPC Configuration**: Uses Helius RPC endpoints from GitHub secrets
             - HTTPS endpoint: From `HELIUS_HTTPS` secret
             - WSS endpoint: From `HELIUS_WSS` secret

          2. **Bot Mode**: The bot will start in **dry-run mode** by default
             - No real transactions will be executed
             - All operations are simulated
             - Safe for testing

          ## How to Test

          1. **Access the Deployment**:
             - Wait for this workflow to complete
             - Navigate to the GitHub Pages URL (provided in workflow output)
             - Expected URL format: `https://<username>.github.io/sol_beast/`

          2. **Open Browser Console**:
             - Press `F12` or `Ctrl+Shift+I` (Chrome/Firefox)
             - Go to the **Console** tab
             - Keep it open while testing

          3. **Configure Bot**:
             - The bot should already have RPC URLs from the workflow
             - Verify in Settings panel that RPC URLs are configured
             - Check that Mode is set to "Dry Run"

          4. **Start the Bot**:
             - Click the "Start" button in the Bot Control panel
             - Monitor the browser console for messages

          5. **Check for Issues**:
             Look for these specific problems in the console:

             ‚úó **Connection Errors**:
             - `WebSocket connection failed`
             - `Failed to connect to RPC`
             - `CORS errors`
             - `ERR_CONNECTION_REFUSED`

             ‚úó **WASM Errors**:
             - `WASM initialization failed`
             - `unreachable executed`
             - `undefined is not a function`
             - Stack traces with `wasm` in them

             ‚úó **No Coins Detected**:
             - Bot running but no new coins appearing in "New Coins" panel
             - No log entries about detected tokens
             - WebSocket connected but silent

             ‚úì **Expected Success Indicators**:
             - `‚úì WASM bot initialized successfully`
             - `‚úì Bot started successfully`
             - WebSocket connection messages
             - Log entries appearing in Logs panel
             - New coins appearing in New Coins panel (if trading activity exists)

          6. **Monitor for 2-5 Minutes**:
             - Let the bot run for a few minutes
             - Check if new coins are detected
             - Verify logs are being generated
             - Ensure no JavaScript errors appear

          7. **Test Dry Run Mode**:
             - If coins are detected, try clicking "Buy" on a coin
             - Verify transaction is NOT actually submitted
             - Check console for "Dry run mode" messages

          ## Expected Results

          ‚úÖ **Success Criteria**:
          - [ ] Bot initializes without errors
          - [ ] WebSocket connection established
          - [ ] RPC connection working
          - [ ] Logs appear in console and UI
          - [ ] New coins detected (if pump.fun has activity)
          - [ ] No critical errors in browser console
          - [ ] Dry run mode prevents actual transactions

          ‚ùå **Failure Indicators**:
          - [ ] WASM module fails to load
          - [ ] WebSocket connection refused/failed
          - [ ] CORS errors on RPC calls
          - [ ] Bot running but no coins detected for >5 minutes
          - [ ] JavaScript errors preventing UI functionality
          - [ ] "unreachable" or "undefined" errors in console

          ## Common Issues and Solutions

          ### Issue: WebSocket Connection Fails
          **Solution**: Verify HELIUS_WSS secret is correctly set in repository settings

          ### Issue: RPC Calls Fail with CORS
          **Solution**: Ensure HELIUS_HTTPS uses a CORS-enabled endpoint

          ### Issue: No Coins Detected
          **Possible Causes**:
          - Pump.fun has no current trading activity (wait longer)
          - WebSocket subscription not working
          - Program ID mismatch in configuration

          ### Issue: WASM Initialization Fails
          **Solution**: Check browser console for specific error messages, may need to clear cache

          ## Reporting Results

          When commenting on the PR, please include:

          1. **Browser & Version**: (e.g., Chrome 120, Firefox 121)
          2. **Deployment URL**: The GitHub Pages URL you tested
          3. **Console Logs**: Copy relevant errors or success messages
          4. **Screenshots**: Capture browser console and UI state
          5. **Test Duration**: How long you monitored the bot
          6. **Coins Detected**: Whether any coins were found
          7. **Overall Result**: ‚úÖ PASS or ‚ùå FAIL with details
          EOF
          echo "‚úì Test instructions created"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./frontend/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output test URL
        run: |
          echo "=========================================="
          echo "GitHub Pages Test Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "üìç Test URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "üìã Test Instructions:"
          echo "1. Open the URL above in your browser"
          echo "2. Press F12 to open browser console"
          echo "3. Start the bot and monitor for errors"
          echo "4. Check if new coins are detected"
          echo ""
          echo "üìñ Detailed instructions available at:"
          echo "   ${{ steps.deployment.outputs.page_url }}TEST_INSTRUCTIONS.md"
          echo ""
          echo "=========================================="
